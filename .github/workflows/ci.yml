name: CI

on:
  pull_request_target:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
# ----------------------- DETECT CHANGES ----------------------- #
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      java-changed: ${{ steps.changes.outputs.java }}
      cpp-changed: ${{ steps.changes.outputs.cpp }}
      csharp-changed: ${{ steps.changes.outputs.csharp }}
      proto-changed: ${{ steps.changes.outputs.proto }}
      docs-changed: ${{ steps.changes.outputs.docs }}
      web-ui-changed: ${{ steps.changes.outputs.web-ui }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            java:
              - 'questnav-lib/**/*.java'
              - 'questnav-lib/**/*.gradle'
            cpp:
              - 'questnav-lib/src/main/native/**/*.cpp'
              - 'questnav-lib/src/main/native/**/*.h'
              - 'questnav-lib/src/main/native/**/*.hpp'
              - 'questnav-lib/**/*.gradle'
            csharp:
              - 'unity/**/*.cs'
              - 'unity/**/*.json'
              - 'unity/**/*.unity'
              - 'unity/**/*.meta'
            proto:
              - 'protos/*.proto'
            docs:
              - 'docs/**'
            web-ui:
              - 'questnav-web-ui/**'
              - 'unity/Assets/StreamingAssets/ui/**'


# ----------------------- JAVA ----------------------- #
  build-proto-java:
    if: |
      needs.detect-changes.outputs.proto-changed == 'true' ||
      needs.detect-changes.outputs.csharp-changed == 'true' ||
      needs.detect-changes.outputs.java-changed == 'true' ||
      needs.detect-changes.outputs.web-ui-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-build-proto-java.yml

  format-java:
    if: needs.detect-changes.outputs.java-changed == 'true'
    needs: [detect-changes, build-proto-java]
    uses: ./.github/workflows/reusable-format-java.yml

  docs-java:
    if: needs.detect-changes.outputs.java-changed == 'true'
    needs: [detect-changes, build-proto-java]
    uses: ./.github/workflows/reusable-docs-javadoc.yml

  build-java:
    if: |
      always() &&
      (needs.detect-changes.outputs.java-changed == 'true' ||
      needs.detect-changes.outputs.csharp-changed == 'true' ||
      needs.detect-changes.outputs.web-ui-changed == 'true') &&
      (needs.format-java.result != 'failure' &&
      needs.docs-java.result != 'failure')
    needs: [detect-changes, format-java, docs-java]
    uses: ./.github/workflows/reusable-build-java.yml

  publish-java:
    if: |
      always() &&
      needs.build-java.result == 'success'
    needs: [build-java]
    uses: ./.github/workflows/reusable-publish-java.yml
    secrets:
      MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
      MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}

# ----------------------- C++ ----------------------- #
  build-proto-cpp:
    if: |
      needs.detect-changes.outputs.proto-changed == 'true' ||
      needs.detect-changes.outputs.java-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-build-proto-cpp.yml

# ----------------------- C# ----------------------- #
  build-proto-csharp:
    if: |
      needs.detect-changes.outputs.proto-changed == 'true' ||
      needs.detect-changes.outputs.csharp-changed == 'true' ||
      needs.detect-changes.outputs.java-changed == 'true' ||
      needs.detect-changes.outputs.web-ui-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-build-proto-csharp.yml
    
  format-csharp:
    if: needs.detect-changes.outputs.csharp-changed == 'true'
    needs: [detect-changes, build-proto-csharp, build-web-ui]
    uses: ./.github/workflows/reusable-format-csharp.yml

  docs-csharp:
    if: needs.detect-changes.outputs.csharp-changed == 'true'
    needs: [detect-changes, build-proto-csharp, build-web-ui]
    uses: ./.github/workflows/reusable-docs-docfx.yml

  build-csharp:
    if: |
      always() &&
      (needs.detect-changes.outputs.csharp-changed == 'true' ||
      needs.detect-changes.outputs.java-changed == 'true' ||
      needs.detect-changes.outputs.web-ui-changed == 'true') &&
      (needs.format-csharp.result != 'failure' &&
      needs.docs-csharp.result != 'failure')
    needs: [detect-changes, docs-csharp, format-csharp]
    uses: ./.github/workflows/reusable-build-csharp.yml
    secrets:
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

# ----------------------- WEB UI ----------------------- #
  build-web-ui:
    if: |
      needs.detect-changes.outputs.web-ui-changed == 'true' ||
      needs.detect-changes.outputs.csharp-changed == 'true' ||
      needs.detect-changes.outputs.java-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-build-web-ui.yml

  
# ----------------------- PROTOBUF ----------------------- #
  docs-proto:
    if: needs.detect-changes.outputs.proto-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-docs-proto.yml

  # ----------------------- DOCS ----------------------- #
  build-docs:
    if: |
      needs.detect-changes.outputs.docs-changed == 'true' &&
      github.event_name == 'pull_request'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-docs-docs.yml

  publish-docs:
    if: |
      needs.detect-changes.outputs.docs-changed == 'true' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    needs: [build-proto-java, build-proto-csharp, build-web-ui, detect-changes]
    uses: ./.github/workflows/reusable-publish-docs.yml
    permissions:
      contents: write
      pages: write
      id-token: write
    with:
      version: 'Development'

  # ----------------------- SUMMARY ----------------------- #
  ci-summary:
    if: always()
    needs:
      - detect-changes
      - format-java
      - build-java
      - docs-java
      - format-csharp
      - build-csharp
      - docs-csharp
      - build-proto-java
      - build-proto-csharp
      - docs-proto
      - build-docs
      - build-web-ui
    runs-on: ubuntu-latest
    steps:
      - name: Generate CI Summary
        run: |
          echo "# CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "- Java: \`${{ needs.detect-changes.outputs.java-changed }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- C#: \`${{ needs.detect-changes.outputs.csharp-changed }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Proto: \`${{ needs.detect-changes.outputs.proto-changed }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Docs: \`${{ needs.detect-changes.outputs.docs-changed }}\`" >> $GITHUB_STEP_SUMMARY